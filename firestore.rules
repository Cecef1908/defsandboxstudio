rules_version = '2';
service cloud.firestore {
  match /databases/{database}/documents {
    
    // ============================================================================
    // HELPER FUNCTIONS
    // ============================================================================
    
    function isAuthenticated() {
      return request.auth != null;
    }
    
    function isAdmin() {
      return isAuthenticated() && 
             get(/databases/$(database)/documents/users/$(request.auth.uid)).data.role in ['super_admin', 'admin'];
    }
    
    function isSuperAdmin() {
      return isAuthenticated() && 
             get(/databases/$(database)/documents/users/$(request.auth.uid)).data.role == 'super_admin';
    }
    
    function isOwner(userId) {
      return isAuthenticated() && request.auth.uid == userId;
    }
    
    function hasRole(role) {
      return isAuthenticated() && 
             get(/databases/$(database)/documents/users/$(request.auth.uid)).data.role == role;
    }
    
    // ============================================================================
    // USERS COLLECTION
    // ============================================================================
    
    match /users/{userId} {
      // Tout utilisateur authentifié peut lire les profils
      allow read: if isAuthenticated();
      
      // Un utilisateur peut créer son propre profil
      allow create: if isAuthenticated() && isOwner(userId);
      
      // Un utilisateur peut modifier son propre profil, ou un admin peut modifier n'importe quel profil
      allow update: if isOwner(userId) || isAdmin();
      
      // Seul un super admin peut supprimer un utilisateur
      allow delete: if isSuperAdmin();
    }
    
    // ============================================================================
    // CRM COLLECTIONS (Clients, Advertisers, Brands, Contacts)
    // ============================================================================
    
    match /clients/{clientId} {
      allow read: if isAuthenticated();
      allow write: if isAdmin();
    }
    
    match /advertisers/{advertiserId} {
      allow read: if isAuthenticated();
      allow write: if isAdmin();
    }
    
    match /brands/{brandId} {
      allow read: if isAuthenticated();
      allow write: if isAdmin();
    }
    
    match /contacts/{contactId} {
      allow read: if isAuthenticated();
      allow write: if isAdmin();
    }
    
    // ============================================================================
    // MEDIA PLANNING COLLECTIONS
    // ============================================================================
    
    match /media-plans/{planId} {
      allow read: if isAuthenticated();
      allow create: if isAuthenticated();
      allow update: if isAuthenticated();
      allow delete: if isAdmin();
    }
    
    match /insertions/{insertionId} {
      allow read: if isAuthenticated();
      allow write: if isAuthenticated();
    }
    
    match /contents/{contentId} {
      allow read: if isAuthenticated();
      allow write: if isAuthenticated();
    }
    
    match /redirect-links/{linkId} {
      allow read: if isAuthenticated();
      allow write: if isAuthenticated();
    }
    
    match /targetings/{targetingId} {
      allow read: if isAuthenticated();
      allow write: if isAuthenticated();
    }
    
    // ============================================================================
    // REFERENCE COLLECTIONS (Read-only for non-admins)
    // ============================================================================
    
    match /ref_channels/{channelId} {
      allow read: if isAuthenticated();
      allow write: if isAdmin();
    }
    
    match /ref_formats/{formatId} {
      allow read: if isAuthenticated();
      allow write: if isAdmin();
    }
    
    match /ref_placements/{placementId} {
      allow read: if isAuthenticated();
      allow write: if isAdmin();
    }
    
    match /ref_buying_models/{modelId} {
      allow read: if isAuthenticated();
      allow write: if isAdmin();
    }
    
    match /ref_publishers/{publisherId} {
      allow read: if isAuthenticated();
      allow write: if isAdmin();
    }
    
    match /ref_channel_categories/{categoryId} {
      allow read: if isAuthenticated();
      allow write: if isAdmin();
    }
    
    match /ref_objectives/{objectiveId} {
      allow read: if isAuthenticated();
      allow write: if isAdmin();
    }
    
    match /ref_buying_units/{unitId} {
      allow read: if isAuthenticated();
      allow write: if isAdmin();
    }
    
    // ============================================================================
    // INVITATIONS COLLECTION
    // ============================================================================
    
    match /invitations/{invitationId} {
      allow read: if isAdmin();
      allow create: if isAdmin();
      allow update: if isAdmin();
      allow delete: if isAdmin();
    }
    
    // ============================================================================
    // TEAMS COLLECTION
    // ============================================================================
    
    match /teams/{teamId} {
      allow read: if isAuthenticated();
      allow write: if isAdmin();
    }
    
    // ============================================================================
    // ACTIVITY LOGS (Read-only, auto-created)
    // ============================================================================
    
    match /activity_logs/{logId} {
      allow read: if isAdmin();
      allow create: if isAuthenticated();
      allow update, delete: if false;
    }
    
    // ============================================================================
    // AGENCY SETTINGS (Super Admin only)
    // ============================================================================
    
    match /agenceSettings/{settingId} {
      allow read: if isAuthenticated();
      allow write: if isSuperAdmin();
    }
    
    match /themes/{themeId} {
      allow read: if isAuthenticated();
      allow write: if isSuperAdmin();
    }
    
    match /logos/{logoId} {
      allow read: if isAuthenticated();
      allow write: if isSuperAdmin();
    }
    
    match /agency_assets/{assetId} {
      allow read: if isAuthenticated();
      allow write: if isAdmin();
    }
  }
}
